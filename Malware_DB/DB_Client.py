import os
import argparse
from tqdm import tqdm
from socket import *

SERVER_IP = "192.168.0.55"
SERVER_PORT = 1113
SAVE_DIRECTORY = "save"

def main():

    global SERVER_IP
    global SERVER_PORT
    global SAVE_DIRECTORY

    parser = argparse.ArgumentParser()

    parser.add_argument('-i', '--input', required=True, type=str, help="The config file path to process.")

    args = vars(parser.parse_args())
    configPath = args['input']

    server = socket(AF_INET, SOCK_STREAM)
    server.connect((SERVER_IP, SERVER_PORT))

    # Send File Size
    print("[DEBUG] Send data Info")
    server.sendall(getFileSize(configPath).encode())

    SERVER_STATE = server.recv(1024)

    # Send File Data
    if SERVER_STATE.decode() == "ready":
        server.sendall(getFileData(configPath).encode())

    while server.recv(1024).decode() != "ready":
        continue

    print("[DEBUG] Start making a spa file")
    fileName = server.recv(1024)
    fileName = fileName.decode()

    msg = "DATA"
    server.sendall(msg.encode())

    SAVE_PATH = os.path.join(SAVE_DIRECTORY, fileName)

    with open(SAVE_PATH, 'w') as fd:
            print("[DEBUG] Receiving data..")
            while True:
                server.sendall("ready".encode())
                data = server.recv(4096)

                fd.write(data.decode())

                if len(data) < 4096:
                    break

    print("[DEBUG] Finish")

def getFileSize(path):
    fileSize = os.path.getsize(path)

    return str(fileSize)


def getFileData(path):
    with open(path, 'r') as fd:
        data = ""

        for line in fd:
            data += line

    return data

if __name__ == "__main__":
    main()

